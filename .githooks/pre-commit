@echo off
REM Pre-commit hook: ensure clang-format is available and format staged files (ShaiKKO style)
REM Windows-friendly using PowerShell; auto-installs via winget/choco if needed.

powershell -NoProfile -ExecutionPolicy Bypass -Command ^
  "$ErrorActionPreference='Stop'; ^
   function Find-ClangFormat {
     $cf = Get-Command clang-format -ErrorAction SilentlyContinue;
     if ($cf) { return $cf.Source }
     $candidates = @(
       'C:\\Program Files\\LLVM\\bin\\clang-format.exe',
       'C:\\Program Files (x86)\\LLVM\\bin\\clang-format.exe',
       'C:\\ProgramData\\chocolatey\\lib\\llvm\\tools\\llvm\\bin\\clang-format.exe'
     )
     foreach ($p in $candidates) { if (Test-Path $p) { return $p } }
     if (Get-Command winget -ErrorAction SilentlyContinue) {
       winget install LLVM.LLVM -e --id LLVM.LLVM --accept-package-agreements --accept-source-agreements | Out-Null
       $cf = Get-Command clang-format -ErrorAction SilentlyContinue; if ($cf) { return $cf.Source }
     } elseif (Get-Command choco -ErrorAction SilentlyContinue) {
       choco install llvm -y | Out-Null
       $cf = Get-Command clang-format -ErrorAction SilentlyContinue; if ($cf) { return $cf.Source }
     }
     return $null
   }
   $clang = Find-ClangFormat; if (-not $clang) { Write-Host 'ERROR: clang-format not found/installed.'; exit 1 }
   $files = git diff --cached --name-only --diff-filter=AM
   foreach ($f in $files) {
     if ($f -match '\\.(c|cpp|h|hpp|hlsl)$') {
       & $clang -i -style=file -- $f
       git add -- $f
     }
   }
   exit 0"
exit /b %ERRORLEVEL%
-NoNewline
