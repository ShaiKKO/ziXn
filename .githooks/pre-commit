#!/usr/bin/env sh

# Pre-commit hook: ensure clang-format is available and format staged files.
# Blocks the commit if clang-format cannot be found or installed.

set -e

detect_clang_format() {
  if command -v clang-format >/dev/null 2>&1; then
    echo "clang-format"
    return 0
  fi
  # Try common LLVM install locations on Windows runners
  for p in \
    "/c/Program Files/LLVM/bin/clang-format.exe" \
    "/mingw64/bin/clang-format.exe" \
    "/usr/bin/clang-format" \
    "/usr/local/opt/llvm/bin/clang-format" \
    "/opt/homebrew/opt/llvm/bin/clang-format"; do
    if [ -x "$p" ]; then echo "$p"; return 0; fi
  done
  done
  return 1
install_clang_format() {
  # Best-effort installer per platform; may require privileges.
  if command -v apt-get >/dev/null 2>&1; then
    sudo apt-get update && sudo apt-get install -y clang-format && return 0
  fi
  if command -v brew >/dev/null 2>&1; then
    brew install clang-format || brew install llvm || return 1
    return 0
  fi
  if command -v choco >/dev/null 2>&1; then
    choco install -y llvm && return 0
  fi
  return 1
}
CF_BIN="$(detect_clang_format || true)"
if [ -z "$CF_BIN" ]; then
  if [ -n "${CI:-}" ] || [ "${ZX_HOOK_AUTO_INSTALL:-0}" = "1" ]; then
    echo "clang-format not found; attempting install..."
    if install_clang_format; then
      CF_BIN="$(detect_clang_format || true)"
    fi
  else
    echo "ERROR: clang-format is required but auto-install is disabled."
    echo "Set ZX_HOOK_AUTO_INSTALL=1 to allow this hook to install it, or install it manually."
  fi
fi

if [ -z "$CF_BIN" ]; then
  echo "ERROR: clang-format is required but could not be installed."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR | \
  grep -E '\.(c|cc|cxx|cpp|h|hh|hpp|hxx|inl|ipp|ixx|hlsl)$' || true)
  echo "Please install clang-format (LLVM) and retry."
  exit 1
fi

# Collect staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | \
  grep -E '\.(c|cpp|h|hpp|hlsl)$' || true)

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

echo "$STAGED_FILES" | while IFS= read -r f; do
  [ -f "$f" ] || continue
  "$CF_BIN" -i -style=file "$f"
  git add "$f"
done

exit 0
